-
    hosts: [ lb-demo-webserver-golden-instance ]
    roles:
        - linux
        - rhel-generic
    tasks:
    -
        name: Download NodeSource repo registrator
        become: yes
        get_url:
            url: "https://rpm.nodesource.com/setup_10.x"
            dest: "~/NodeSource.reg.sh"
            mode: '0755'
    -
        name: Add NodeSource repository
        become: yes
        shell: "~/NodeSource.reg.sh"
    -
        name: Install ExpressJS dependencies
        become: yes
        yum:
            name:
                - "nodejs"
                - "gcc-c++"
                - "make"
    -
        name: Clone the Web Frontend source
        shell: "[ -d {{ project_name }} ] || /bin/git clone {{ project_repo }} {{ project_name }}"
    -
        name: Update the Web Frontend source
        command: "/bin/git pull"
        args:
            chdir: "{{ project_name }}"
    -
        name: Modify the DB server in the frontend config
        lineinfile:
            path: "{{ project_name }}/config.json"
            backrefs: true
            regexp: '^(\s*"db_server":\s*)"[^"]*"(.*)'
            line: '\1"lb-demo-dbserver"\2'
    -
        name: task1
        command: "/usr/bin/npm install"
        args:
            chdir: "{{ project_name }}"
    -
        name: Build the Frontend server
        command: "/usr/bin/npm run builddev"
        args:
            chdir: "{{ project_name }}"
    -
        name: Generate service descriptor file
        become: yes
        template:
            src: "templates/service_file.j2"
            dest: "/etc/systemd/system/{{ project_name }}.service"
            owner: "root"
            group: "root"
            mode: '0644'
    -
        name: Enable the Frontend as a service
        become: yes
        command: "/usr/bin/systemctl enable {{ project_name }}"
    -
        name: Shut down the instance
        become: yes
        shell: "sleep 2 && /sbin/shutdown -c && /sbin/shutdown -h now"
        async: 1
        poll: 0
    -
        name: Save target host IP
        set_fact:
            target_host: "{{ ansible_host }}"
    -
        name: Wait to go down
        wait_for: "port=22 host={{ target_host }} delay=10 state=stopped timeout=60"
        delegate_to: 127.0.0.1


# vim: set sw=4 ts=4 et:
